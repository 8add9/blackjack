<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>21é» - ç®¡ç†å“¡å¾Œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .table-glass {
            background-color: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            overflow: hidden;
        }
        th { background-color: rgba(13, 110, 253, 0.2) !important; }
        
        .modal-backdrop.show {
            opacity: 0.8;
            backdrop-filter: blur(5px);
        }

        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– CSS */
        @media (max-width: 768px) {
            .admin-container {
                padding-left: 5px !important;
                padding-right: 5px !important;
            }
            /* æ‰‹æ©Ÿç‰ˆå­—é«”ç¸®å°ä¸€é» */
            .table {
                font-size: 0.9rem;
            }
            .btn-sm {
                padding: 0.25rem 0.4rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="bg-dark text-light">

    <div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary justify-content-center">
                    <h4 class="modal-title fw-bold text-warning">ğŸ›¡ï¸ ç®¡ç†å“¡ç™»å…¥</h4>
                </div>
                <div class="modal-body p-4">
                    <form id="login-form" onsubmit="event.preventDefault(); adminLogin();">
                        <div class="mb-3">
                            <label class="form-label text-muted">å¸³è™Ÿ</label>
                            <input type="text" id="admin-user" class="form-control text-center" placeholder="Admin Username" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-muted">å¯†ç¢¼</label>
                            <input type="password" id="admin-pass" class="form-control text-center" placeholder="Password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">é©—è­‰èº«ä»½</button>
                        </div>
                        <div id="login-msg" class="mt-3 text-center text-danger small"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid container-lg py-3 py-md-5 admin-container d-none" id="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-warning m-0">ğŸ› ï¸ ç®¡ç†å¾Œå°</h4>
            <div>
                <a href="index.html" class="btn btn-outline-light btn-sm me-1">å›éŠæˆ²</a>
                <button onclick="loadUsers()" class="btn btn-primary btn-sm">ğŸ”„ åˆ·æ–°</button>
                <button onclick="logout()" class="btn btn-danger btn-sm ms-1">ç™»å‡º</button>
            </div>
        </div>

        <div id="admin-message" class="alert d-none text-center p-2 mb-3 small"></div>

        <div class="table-responsive table-glass shadow-lg border border-secondary">
            <table class="table table-dark table-hover mb-0 align-middle">
                <thead>
                    <tr>
                        <th scope="col" class="py-3 ps-3 d-none d-md-table-cell">ID</th>
                        <th scope="col" class="py-3">å¸³è™Ÿ</th>
                        <th scope="col" class="py-3">ç±Œç¢¼</th>
                        <th scope="col" class="py-3 text-end pe-3">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    <tr><td colspan="4" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="editBalanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">ä¿®æ”¹ç±Œç¢¼</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <input type="hidden" id="edit-username">
                        <div class="mb-3">
                            <label class="form-label text-muted">ç©å®¶å¸³è™Ÿ</label>
                            <input type="text" id="display-username" class="form-control" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">è¨­å®šæ–°ç±Œç¢¼é‡‘é¡</label>
                            <input type="number" id="new-balance" class="form-control form-control-lg text-warning fw-bold" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" onclick="submitBalanceChange()" class="btn btn-success">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-info">ä¿®æ”¹å¯†ç¢¼</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <input type="hidden" id="pwd-username">
                        <div class="mb-3">
                            <label class="form-label text-muted">ç©å®¶å¸³è™Ÿ</label>
                            <input type="text" id="pwd-display-username" class="form-control" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">è¨­å®šæ–°å¯†ç¢¼</label>
                            <input type="text" id="new-password" class="form-control" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" onclick="submitPasswordChange()" class="btn btn-info">ç¢ºèª</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="tierModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">ğŸ›ï¸ èª¿æ•´å‹ç‡</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <input type="hidden" id="tier-username">
                        <div class="mb-3">
                            <label class="form-label text-muted">ç©å®¶å¸³è™Ÿ</label>
                            <input type="text" id="tier-display-username" class="form-control" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">é¸æ“‡æ¨¡å¼</label>
                            <select id="select-tier" class="form-select form-select-lg bg-dark text-light border-secondary">
                                <option value="1">ğŸŸ¢ æª”ä½ä¸€ï¼šç©å®¶ç„¡é™è´ (God Mode)</option>
                                <option value="2">ğŸ”µ æª”ä½äºŒï¼šç©å®¶é«˜å‹ç‡ (75%)</option>
                                <option value="3">âšª æª”ä½ä¸‰ï¼šæ­£å¸¸æ©Ÿç‡ (å…¬å¹³)</option>
                                <option value="4">ğŸ”´ æª”ä½å››ï¼šç©å®¶å¿…è¼¸ (æ®ºè±¬ç›¤)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" onclick="submitTierChange()" class="btn btn-danger">å¥—ç”¨</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================
        // è¨­å®šå€åŸŸ
        // ==========================================
        const API_BASE_URL = "https://reed-unhyphenated-su.ngrok-free.dev"; 

        let adminToken = "";
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        const editModal = new bootstrap.Modal(document.getElementById('editBalanceModal'));
        const pwdModal = new bootstrap.Modal(document.getElementById('changePasswordModal')); 
        const tierModal = new bootstrap.Modal(document.getElementById('tierModal'));
        const tableBody = document.getElementById('user-table-body');
        const elMsg = document.getElementById('admin-message');
        const mainContent = document.getElementById('main-content');

        window.onload = () => { loginModal.show(); };

        async function adminLogin() {
            const user = document.getElementById('admin-user').value;
            const pass = document.getElementById('admin-pass').value;
            const msgArea = document.getElementById('login-msg');
            msgArea.innerText = "é©—è­‰ä¸­...";

            try {
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ username: user, password: pass })
                });

                const data = await response.json();
                if (response.ok) {
                    adminToken = data.token;
                    loginModal.hide();
                    mainContent.classList.remove('d-none');
                    loadUsers();
                } else {
                    msgArea.innerText = data.message || "ç™»å…¥å¤±æ•—";
                }
            } catch (error) { console.error(error); msgArea.innerText = "é€£ç·šéŒ¯èª¤"; }
        }

        function logout() { location.reload(); }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken, 'ngrok-skip-browser-warning': 'true' }
                });

                if (response.status === 401) { alert("æ†‘è­‰éæœŸ"); logout(); return; }

                const users = await response.json();
                tableBody.innerHTML = ''; 

                if (users.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">æš«ç„¡ç©å®¶è³‡æ–™</td></tr>`;
                    return;
                }

                users.forEach(user => {
                    let tierLabel = "âšª";
                    if(user.win_tier === 1) tierLabel = "ğŸŸ¢";
                    if(user.win_tier === 2) tierLabel = "ğŸ”µ";
                    if(user.win_tier === 4) tierLabel = "ğŸ”´";

                    const row = `
                        <tr>
                            <td class="ps-3 text-secondary d-none d-md-table-cell">#${user.id}</td>
                            <td class="fw-bold">
                                <div>${user.username}</div>
                                <span class="badge bg-secondary" style="font-size:0.6em">${tierLabel}</span>
                            </td>
                            <td class="text-warning fw-bold">$${user.balance}</td>
                            <td class="text-end pe-3">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-warning btn-sm" onclick="openEditModal('${user.username}', ${user.balance})">âœï¸</button>
                                    <button class="btn btn-info btn-sm" onclick="openPasswordModal('${user.username}')">ğŸ”‘</button>
                                    <button class="btn btn-danger btn-sm" onclick="openTierModal('${user.username}', ${user.win_tier})">ğŸ›ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) { console.error(error); showMessage("ç„¡æ³•é€£æ¥ä¼ºæœå™¨", "danger"); }
        }

        function openEditModal(username, currentBalance) {
            document.getElementById('edit-username').value = username;
            document.getElementById('display-username').value = username;
            document.getElementById('new-balance').value = currentBalance;
            editModal.show();
        }

        async function submitBalanceChange() {
            const username = document.getElementById('edit-username').value;
            const newBalance = parseInt(document.getElementById('new-balance').value);
            if (isNaN(newBalance)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—");
            
            await sendAdminRequest('/admin/update_balance', { username: username, amount: newBalance }, editModal, "ç±Œç¢¼æ›´æ–°æˆåŠŸ");
        }

        function openPasswordModal(username) {
            document.getElementById('pwd-username').value = username;
            document.getElementById('pwd-display-username').value = username;
            document.getElementById('new-password').value = ""; 
            pwdModal.show();
        }

        async function submitPasswordChange() {
            const username = document.getElementById('pwd-username').value;
            const newPassword = document.getElementById('new-password').value.trim();
            if (!newPassword) return alert("è«‹è¼¸å…¥æ–°å¯†ç¢¼");

            await sendAdminRequest('/admin/change_password', { username: username, new_password: newPassword }, pwdModal, "å¯†ç¢¼ä¿®æ”¹æˆåŠŸ");
        }

        function openTierModal(username, currentTier) {
            document.getElementById('tier-username').value = username;
            document.getElementById('tier-display-username').value = username;
            document.getElementById('select-tier').value = currentTier || 3;
            tierModal.show();
        }

        async function submitTierChange() {
            const username = document.getElementById('tier-username').value;
            const tier = document.getElementById('select-tier').value;
            await sendAdminRequest('/admin/set_tier', { username: username, tier: tier }, tierModal, "å‹ç‡èª¿æ•´æˆåŠŸ");
        }

        // çµ±ä¸€è™•ç† API è«‹æ±‚çš„è¼”åŠ©å‡½å¼
        async function sendAdminRequest(endpoint, bodyData, modalInstance, successMsg) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken, 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify(bodyData)
                });
                const result = await response.json();
                if (response.ok) {
                    modalInstance.hide();
                    showMessage(successMsg, "success");
                    loadUsers(); 
                } else {
                    alert("å¤±æ•—: " + result.message);
                }
            } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
        }

        function showMessage(msg, type) {
            elMsg.className = `alert alert-${type} text-center p-2 mb-3 small`;
            elMsg.innerText = msg;
            elMsg.classList.remove('d-none');
            setTimeout(() => elMsg.classList.add('d-none'), 3000);
        }
    </script>
</body>
</html>
